---
import { Icon } from 'astro-icon/components';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class={`budget-builder-container ${className || ''}`}>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Progress Bar -->
    <div class="mb-8">
      <div class="flex justify-between mb-2">
        <span class="text-sm font-medium text-muted">Paso <span id="current-step">1</span> de 4</span>
        <span class="text-sm font-medium text-c-purple"><span id="progress-percent">25</span>%</span>
      </div>
      <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-full bg-gradient-c-purple transition-all duration-300" style="width: 25%"></div>
      </div>
    </div>

    <!-- Step 1: Initial Setup -->
    <div id="step-1" class="step-content">
      <div class="space-y-6">
        <div>
          <h2 class="text-3xl font-bold font-heading mb-2">¿Qué tienes ya preparado?</h2>
          <p class="text-muted">Esto nos ayuda a entender desde dónde partimos y ajustar el presupuesto</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Branding -->
          <label class="option-card cursor-pointer" data-option="branding">
            <input type="checkbox" class="hidden option-checkbox" name="basics" value="branding">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-lg bg-c-purple/10 flex items-center justify-center">
                  <Icon name="tabler:palette" class="w-6 h-6 text-c-purple" />
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-purple" />
                </div>
              </div>
              <h3 class="font-bold mb-2">Branding Definido</h3>
              <p class="text-sm text-muted">Ya tengo logo, colores corporativos e identidad visual</p>
            </div>
          </label>

          <!-- Diseños -->
          <label class="option-card cursor-pointer" data-option="designs">
            <input type="checkbox" class="hidden option-checkbox" name="basics" value="designs">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-lg bg-c-blue/10 flex items-center justify-center">
                  <Icon name="tabler:layout-dashboard" class="w-6 h-6 text-c-blue" />
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-blue" />
                </div>
              </div>
              <h3 class="font-bold mb-2">Diseños UI/UX</h3>
              <p class="text-sm text-muted">Tengo mockups o wireframes del proyecto</p>
            </div>
          </label>

          <!-- Dominio -->
          <label class="option-card cursor-pointer" data-option="domain">
            <input type="checkbox" class="hidden option-checkbox" name="basics" value="domain">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-lg bg-c-yellow/10 flex items-center justify-center">
                  <Icon name="tabler:world" class="w-6 h-6 text-c-yellow" />
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-yellow" />
                </div>
              </div>
              <h3 class="font-bold mb-2">Dominio Registrado</h3>
              <p class="text-sm text-muted">Ya tengo un dominio (.com, .com.ar, etc.)</p>
            </div>
          </label>

          <!-- Cloud Services -->
          <label class="option-card cursor-pointer" data-option="cloud">
            <input type="checkbox" class="hidden option-checkbox" name="basics" value="cloud">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-lg bg-c-red/10 flex items-center justify-center">
                  <Icon name="tabler:cloud" class="w-6 h-6 text-c-red" />
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-red" />
                </div>
              </div>
              <h3 class="font-bold mb-2">Servicios Cloud</h3>
              <p class="text-sm text-muted">Tengo hosting, base de datos o servicios configurados</p>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 2: Project Type -->
    <div id="step-2" class="step-content hidden">
      <div class="space-y-6">
        <div>
          <h2 class="text-3xl font-bold font-heading mb-2">¿Qué tipo de proyecto necesitas?</h2>
          <p class="text-muted">Selecciona la opción que mejor describa tu necesidad</p>
        </div>
        
        <div class="space-y-4">
          <!-- Landing Page -->
          <label class="option-card cursor-pointer" data-option="landing">
            <input type="radio" class="hidden option-radio" name="project-type" value="landing">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-lg bg-c-purple/10 flex items-center justify-center flex-shrink-0">
                  <Icon name="tabler:layout" class="w-7 h-7 text-c-purple" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold mb-1 text-lg">Landing Page / Sitio Web</h3>
                  <p class="text-sm text-muted">Una página de presentación para tu producto o servicio. Ideal para marketing, conversión y presencia online.</p>
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-purple" />
                </div>
              </div>
            </div>
          </label>

          <!-- Web/Mobile App -->
          <label class="option-card cursor-pointer" data-option="app">
            <input type="radio" class="hidden option-radio" name="project-type" value="app">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-lg bg-c-blue/10 flex items-center justify-center flex-shrink-0">
                  <Icon name="tabler:device-mobile" class="w-7 h-7 text-c-blue" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold mb-1 text-lg">Aplicación Web/Móvil</h3>
                  <p class="text-sm text-muted">Un sistema completo con usuarios, base de datos y funcionalidades avanzadas. Para gestión interna o servicios digitales.</p>
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-blue" />
                </div>
              </div>
            </div>
          </label>

          <!-- Both -->
          <label class="option-card cursor-pointer" data-option="both">
            <input type="radio" class="hidden option-radio" name="project-type" value="both">
            <div class="p-6 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-lg bg-gradient-c-purple flex items-center justify-center flex-shrink-0">
                  <Icon name="tabler:layout-grid" class="w-7 h-7 text-white" />
                </div>
                <div class="flex-1">
                  <h3 class="font-bold mb-1 text-lg">Ambas (Landing + App)</h3>
                  <p class="text-sm text-muted">Una landing page para marketing y captación, más una aplicación para el servicio. La solución completa.</p>
                </div>
                <div class="checkmark hidden">
                  <Icon name="tabler:check" class="w-6 h-6 text-c-purple" />
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 3: Modules -->
    <div id="step-3" class="step-content hidden">
      <div class="space-y-6">
        <div>
          <h2 class="text-3xl font-bold font-heading mb-2">¿Qué funcionalidades necesitas?</h2>
          <p class="text-muted">Selecciona todos los módulos que tu proyecto requiera</p>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <!-- E-commerce -->
          <label class="option-card cursor-pointer" data-option="ecommerce">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="ecommerce">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-purple/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:shopping-cart" class="w-6 h-6 text-c-purple" />
              </div>
              <span class="font-medium text-sm">E-commerce</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-purple mx-auto" />
              </div>
            </div>
          </label>

          <!-- Turnero/Agenda -->
          <label class="option-card cursor-pointer" data-option="scheduling">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="scheduling">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-blue transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-blue/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:calendar" class="w-6 h-6 text-c-blue" />
              </div>
              <span class="font-medium text-sm">Turnero/Agenda</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-blue mx-auto" />
              </div>
            </div>
          </label>

          <!-- Admin Panel -->
          <label class="option-card cursor-pointer" data-option="admin">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="admin">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-red transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-red/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:settings" class="w-6 h-6 text-c-red" />
              </div>
              <span class="font-medium text-sm">Panel Admin</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-red mx-auto" />
              </div>
            </div>
          </label>

          <!-- Medical History -->
          <label class="option-card cursor-pointer" data-option="medical">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="medical">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-purple transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-purple/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:heart-rate-monitor" class="w-6 h-6 text-c-purple" />
              </div>
              <span class="font-medium text-sm">Historial Médico</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-purple mx-auto" />
              </div>
            </div>
          </label>

          <!-- Event Planning -->
          <label class="option-card cursor-pointer" data-option="events">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="events">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-yellow transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-yellow/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:confetti" class="w-6 h-6 text-c-yellow" />
              </div>
              <span class="font-medium text-sm">Eventos</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-yellow mx-auto" />
              </div>
            </div>
          </label>

          <!-- Legal Package -->
          <label class="option-card cursor-pointer" data-option="legal">
            <input type="checkbox" class="hidden option-checkbox" name="modules" value="legal">
            <div class="p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-c-blue transition-all text-center">
              <div class="w-12 h-12 rounded-lg bg-c-blue/10 flex items-center justify-center mx-auto mb-3">
                <Icon name="tabler:scale" class="w-6 h-6 text-c-blue" />
              </div>
              <span class="font-medium text-sm">Paquete Jurídico</span>
              <div class="checkmark-small hidden mt-2">
                <Icon name="tabler:check" class="w-4 h-4 text-c-blue mx-auto" />
              </div>
            </div>
          </label>
        </div>
      </div>
    </div>

    <!-- Step 4: Summary -->
    <div id="step-4" class="step-content hidden">
      <div class="space-y-6">
        <div>
          <h2 class="text-3xl font-bold font-heading mb-2">Resumen de tu proyecto</h2>
          <p class="text-muted">Revisa tu selección y solicita tu presupuesto personalizado</p>
        </div>
        
        <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl space-y-6">
          <!-- Basics Summary -->
          <div>
            <h3 class="font-bold text-sm text-muted uppercase tracking-wider mb-3">Ya tienes preparado</h3>
            <div id="basics-summary" class="flex flex-wrap gap-2">
              <span class="text-sm text-muted italic">Ninguna selección</span>
            </div>
          </div>
          
          <!-- Project Type Summary -->
          <div>
            <h3 class="font-bold text-sm text-muted uppercase tracking-wider mb-3">Tipo de Proyecto</h3>
            <div id="type-summary" class="text-lg font-medium text-c-purple">
              No seleccionado
            </div>
          </div>

          <!-- Modules Summary -->
          <div>
            <h3 class="font-bold text-sm text-muted uppercase tracking-wider mb-3">Funcionalidades</h3>
            <div id="modules-summary" class="flex flex-wrap gap-2">
              <span class="text-sm text-muted italic">Ninguna selección</span>
            </div>
          </div>
        </div>

        <!-- Contact Form -->
        <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
          <h3 class="font-bold mb-4">Datos de contacto</h3>
          <form id="budget-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input 
                type="text" 
                name="name" 
                placeholder="Nombre completo" 
                required
                class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-c-purple focus:ring-2 focus:ring-c-purple/20 outline-none transition-all"
              >
              <input 
                type="email" 
                name="email" 
                placeholder="Email" 
                required
                class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-c-purple focus:ring-2 focus:ring-c-purple/20 outline-none transition-all"
              >
            </div>
            <input 
              type="tel" 
              name="phone" 
              placeholder="Teléfono (opcional)" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-c-purple focus:ring-2 focus:ring-c-purple/20 outline-none transition-all"
            >
            <textarea 
              name="message" 
              placeholder="Cuéntanos más sobre tu proyecto..." 
              rows="4"
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-c-purple focus:ring-2 focus:ring-c-purple/20 outline-none transition-all"
            ></textarea>
            <button 
              type="submit"
              class="w-full px-6 py-4 bg-gradient-c-purple text-white font-bold rounded-lg hover:shadow-lg hover:scale-[1.02] transition-all"
            >
              Solicitar Presupuesto
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
      <button 
        id="prev-btn"
        class="px-6 py-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-c-purple hover:text-c-purple transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:border-gray-300 dark:disabled:hover:border-gray-600 disabled:hover:text-current"
      >
        <Icon name="tabler:chevron-left" class="w-5 h-5 inline mr-2" />
        Anterior
      </button>
      
      <button 
        id="next-btn"
        class="px-6 py-3 bg-gradient-c-purple text-white font-bold rounded-lg hover:shadow-lg hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none disabled:hover:scale-100"
      >
        Siguiente
        <Icon name="tabler:chevron-right" class="w-5 h-5 inline ml-2" />
      </button>
    </div>
  </div>
</div>

<script>
  // Budget Builder Logic
  let currentStep = 1;
  const totalSteps = 4;
  const selections = {
    basics: [] as string[],
    type: '',
    modules: [] as string[],
  };

  // Update progress bar
  function updateProgress() {
    const percent = (currentStep / totalSteps) * 100;
    const progressBar = document.getElementById('progress-bar');
    const currentStepEl = document.getElementById('current-step');
    const progressPercent = document.getElementById('progress-percent');
    
    if (progressBar) progressBar.style.width = `${percent}%`;
    if (currentStepEl) currentStepEl.textContent = currentStep.toString();
    if (progressPercent) progressPercent.textContent = Math.round(percent).toString();
  }

  // Show specific step
  function showStep(step: number) {
    // Hide all steps
    for (let i = 1; i <= totalSteps; i++) {
      const stepEl = document.getElementById(`step-${i}`);
      if (stepEl) stepEl.classList.add('hidden');
    }
    
    // Show current step
    const currentStepEl = document.getElementById(`step-${step}`);
    if (currentStepEl) currentStepEl.classList.remove('hidden');
    
    // Update buttons
    const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
    
    if (prevBtn) prevBtn.disabled = step === 1;
    if (nextBtn) {
      if (step === totalSteps) {
        nextBtn.classList.add('hidden');
      } else {
        nextBtn.classList.remove('hidden');
      }
    }
    
    updateProgress();
  }

  // Navigate to next step
  function nextStep() {
    if (currentStep === 2 && !selections.type) {
      alert('Por favor selecciona un tipo de proyecto');
      return;
    }
    
    if (currentStep < totalSteps) {
      currentStep++;
      showStep(currentStep);
      
      if (currentStep === totalSteps) {
        updateSummary();
      }
    }
  }

  // Navigate to previous step
  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  }

  // Update summary on step 4
  function updateSummary() {
    // Basics
    const basicsSummary = document.getElementById('basics-summary');
    if (basicsSummary) {
      if (selections.basics.length > 0) {
        const labels: Record<string, string> = {
          branding: 'Branding',
          designs: 'Diseños UI/UX',
          domain: 'Dominio',
          cloud: 'Servicios Cloud'
        };
        basicsSummary.innerHTML = selections.basics
          .map(id => `<span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-sm border border-gray-200 dark:border-gray-600">${labels[id]}</span>`)
          .join('');
      } else {
        basicsSummary.innerHTML = '<span class="text-sm text-muted italic">Ninguna selección</span>';
      }
    }
    
    // Type
    const typeSummary = document.getElementById('type-summary');
    if (typeSummary) {
      const typeLabels: Record<string, string> = {
        landing: 'Landing Page / Sitio Web',
        app: 'Aplicación Web/Móvil',
        both: 'Ambas (Landing + App)'
      };
      typeSummary.textContent = selections.type ? typeLabels[selections.type] : 'No seleccionado';
    }
    
    // Modules
    const modulesSummary = document.getElementById('modules-summary');
    if (modulesSummary) {
      if (selections.modules.length > 0) {
        const labels: Record<string, string> = {
          ecommerce: 'E-commerce',
          scheduling: 'Turnero/Agenda',
          admin: 'Panel Admin',
          medical: 'Historial Médico',
          events: 'Eventos',
          legal: 'Paquete Jurídico'
        };
        modulesSummary.innerHTML = selections.modules
          .map(id => `<span class="px-3 py-1 bg-white dark:bg-gray-700 rounded-full text-sm border border-gray-200 dark:border-gray-600">${labels[id]}</span>`)
          .join('');
      } else {
        modulesSummary.innerHTML = '<span class="text-sm text-muted italic">Ninguna selección</span>';
      }
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    showStep(1);
    
    // Navigation buttons
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    
    if (nextBtn) nextBtn.addEventListener('click', nextStep);
    if (prevBtn) prevBtn.addEventListener('click', prevStep);
    
    // Checkbox options
    document.querySelectorAll('.option-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const card = target.closest('.option-card');
        const value = target.value;
        const name = target.name;
        
        if (target.checked) {
          card?.querySelector('.checkmark, .checkmark-small')?.classList.remove('hidden');
          card?.querySelector('div')?.classList.add('border-c-purple', 'bg-c-purple/5');
          
          if (name === 'basics') {
            selections.basics.push(value);
          } else if (name === 'modules') {
            selections.modules.push(value);
          }
        } else {
          card?.querySelector('.checkmark, .checkmark-small')?.classList.add('hidden');
          card?.querySelector('div')?.classList.remove('border-c-purple', 'bg-c-purple/5');
          
          if (name === 'basics') {
            selections.basics = selections.basics.filter(v => v !== value);
          } else if (name === 'modules') {
            selections.modules = selections.modules.filter(v => v !== value);
          }
        }
      });
    });
    
    // Radio options
    document.querySelectorAll('.option-radio').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        
        // Remove selection from all radio cards
        document.querySelectorAll('input[name="project-type"]').forEach(r => {
          const card = r.closest('.option-card');
          card?.querySelector('.checkmark')?.classList.add('hidden');
          card?.querySelector('div')?.classList.remove('border-c-purple', 'bg-c-purple/5');
        });
        
        // Add selection to current card
        const card = target.closest('.option-card');
        card?.querySelector('.checkmark')?.classList.remove('hidden');
        card?.querySelector('div')?.classList.add('border-c-purple', 'bg-c-purple/5');
        
        selections.type = target.value;
      });
    });
    
    // Form submission
    const form = document.getElementById('budget-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form as HTMLFormElement);
        const data = {
          ...Object.fromEntries(formData),
          selections
        };
        
        console.log('Budget request:', data);
        alert('¡Gracias! Nos pondremos en contacto contigo pronto con tu presupuesto personalizado.');
        
        // Here you would typically send the data to your backend
        // fetch('/api/budget', { method: 'POST', body: JSON.stringify(data) })
      });
    }
  });
</script>

<style>
  .step-content {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateX(10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
