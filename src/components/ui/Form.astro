---
import type { Form as Props } from '~/types';
import Button from '~/components/ui/Button.astro';

const { inputs, textarea, disclaimer, button = 'Contact us', description = '' } = Astro.props;
---

<form id="contact-form">
  {
    inputs &&
      inputs.map(
        ({ type = 'text', name, label = '', autocomplete = 'on', placeholder = '' }) =>
          name && (
            <div class="mb-6">
              {label && (
                <label for={name} class="block text-sm font-medium mb-2">
                  {label}
                </label>
              )}
              <input
                type={type}
                name={name}
                id={name}
                autocomplete={autocomplete}
                placeholder={placeholder}
                required={name === 'name' || name === 'email'}
                class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-commit focus:border-commit transition-all"
              />
            </div>
          )
      )
  }

  {
    textarea && (
      <div class="mb-6">
        <label for="textarea" class="block text-sm font-medium mb-2">
          {textarea.label}
        </label>
        <textarea
          id="textarea"
          name={textarea.name ? textarea.name : 'message'}
          rows={textarea.rows ? textarea.rows : 4}
          placeholder={textarea.placeholder}
          required
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-commit focus:border-commit transition-all"
        />
      </div>
    )
  }

  {
    disclaimer && (
      <div class="mt-3 flex items-start mb-6">
        <div class="flex mt-0.5">
          <input
            id="disclaimer"
            name="disclaimer"
            type="checkbox"
            class="cursor-pointer mt-1 w-4 h-4 text-commit border-gray-300 rounded focus:ring-commit"
          />
        </div>
        <div class="ml-3">
          <label for="disclaimer" class="cursor-pointer select-none text-sm text-gray-600 dark:text-gray-400">
            {disclaimer.label}
          </label>
        </div>
      </div>
    )
  }

  <!-- Contact Method Selection -->
  <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700">
    <label class="block text-sm font-medium mb-3">
      ¿Por qué vía querés que nos comuniquemos?
    </label>
    <div class="flex flex-col sm:flex-row gap-3">
      <label class="flex-1 cursor-pointer">
        <input
          type="radio"
          name="contact_method"
          value="email"
          checked
          class="peer sr-only"
        />
        <div class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-commit peer-checked:bg-commit/5 peer-checked:dark:bg-commit/10 transition-all hover:border-commit/50 flex items-center gap-3">
          <svg class="w-5 h-5 text-commit" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span class="font-medium">Email</span>
        </div>
      </label>
      <label class="flex-1 cursor-pointer">
        <input
          type="radio"
          name="contact_method"
          value="whatsapp"
          class="peer sr-only"
        />
        <div class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-commit peer-checked:bg-commit/5 peer-checked:dark:bg-commit/10 transition-all hover:border-commit/50 flex items-center gap-3">
          <svg class="w-5 h-5 text-commit" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          <span class="font-medium">WhatsApp</span>
        </div>
      </label>
    </div>
  </div>

  <div id="form-message" class="mt-4 text-sm hidden"></div>

  {
    button && (
      <div class="mt-6 grid">
        <Button variant="primary" type="submit">
          {button}
        </Button>
      </div>
    )
  }

  {
    description && (
      <div class="mt-3 text-center">
        <p class="text-sm text-gray-600 dark:text-gray-400">{description}</p>
      </div>
    )
  }
</form>

<script>
  import { initEmailJS, sendContactEmail, generateContactWhatsAppMessage, openWhatsApp } from '~/utils/email';

  // Inicializar EmailJS
  initEmailJS();

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const messageDiv = document.getElementById('form-message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitButton.textContent;
      
      // Obtener método de contacto seleccionado
      const contactMethod = (form.querySelector('input[name="contact_method"]:checked') as HTMLInputElement)?.value || 'email';
      
      // Validar campos requeridos
      const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
      let hasEmptyFields = false;
      
      requiredInputs.forEach((input) => {
        if (!(input as HTMLInputElement).value.trim()) {
          hasEmptyFields = true;
          input.classList.add('animate-shake', 'border-red-500');
          setTimeout(() => {
            input.classList.remove('animate-shake', 'border-red-500');
          }, 500);
        }
      });
      
      if (hasEmptyFields) {
        if (messageDiv) {
          messageDiv.textContent = 'Por favor, completá todos los campos requeridos.';
          messageDiv.className = 'mt-4 text-sm p-3 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 rounded-lg animate-shake';
          messageDiv.classList.remove('hidden');
          setTimeout(() => {
            messageDiv.classList.remove('animate-shake');
          }, 500);
        }
        return;
      }
      
      const formData = new FormData(form);
      const data = {
        name: formData.get('name') as string,
        email: formData.get('email') as string,
        message: formData.get('message') as string,
      };

      // Si eligió WhatsApp, abrir WhatsApp y no enviar email
      if (contactMethod === 'whatsapp') {
        const whatsappMessage = generateContactWhatsAppMessage({
          name: data.name,
          message: data.message,
        });
        
        openWhatsApp(whatsappMessage);
        
        if (messageDiv) {
          messageDiv.textContent = '¡Perfecto! Se abrió WhatsApp con tu mensaje. Solo presioná enviar.';
          messageDiv.className = 'mt-4 text-sm p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 rounded-lg';
          messageDiv.classList.remove('hidden');
        }
        
        form.reset();
        return;
      }
      
      // Si eligió Email, enviar por EmailJS
      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';
      
      try {
        await sendContactEmail(data);
        
        if (messageDiv) {
          messageDiv.textContent = '¡Mensaje enviado exitosamente! Nos pondremos en contacto pronto.';
          messageDiv.className = 'mt-4 text-sm p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 rounded-lg';
          messageDiv.classList.remove('hidden');
        }
        
        form.reset();
        
      } catch (error) {
        console.error('Error:', error);
        
        if (messageDiv) {
          messageDiv.innerHTML = 'Hubo un error al enviar el mensaje. Por favor, intenta nuevamente o <a href="#" id="fallback-whatsapp" class="underline font-semibold">contáctanos por WhatsApp</a>.';
          messageDiv.className = 'mt-4 text-sm p-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100 rounded-lg animate-shake';
          messageDiv.classList.remove('hidden');
          
          // Agregar handler para fallback a WhatsApp
          setTimeout(() => {
            const fallbackLink = document.getElementById('fallback-whatsapp');
            if (fallbackLink) {
              fallbackLink.addEventListener('click', (e) => {
                e.preventDefault();
                const whatsappMessage = generateContactWhatsAppMessage({
                  name: data.name,
                  message: data.message,
                });
                openWhatsApp(whatsappMessage);
              });
            }
            messageDiv.classList.remove('animate-shake');
          }, 500);
        }
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });
  }
</script>
